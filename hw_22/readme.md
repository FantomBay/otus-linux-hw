# Мосты, туннели и VPN.

Домашнее задание:

1. Между двумя виртуалками поднять vpn в режимах

    * tun;
    * tap; Прочуствовать разницу.

2.    Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.  

3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке Формат сдачи ДЗ - vagrant + ansible

--- 

1. Замер скорости для tun и tap:

Для запуска 1 части ДР развернем тестовый стенд при помощи vagrant:
```
vagrant up
```
И запустим плейбук
```
ansible-playbook playbook1.yml
```
Далее для замера скорости - на ```server``` запускаем: 
```
iperf3 -s &
```
а на ```client``` запускаем:
```
iperf3 -c 10.10.10.1 -t 40 -i 5
```
Замер скорости для tap:
<details>
 <summary> Вывод 3-х замеров </summary>

    [root@client ~]# iperf3 -c 10.10.10.1 -t 40 -i 5
    Connecting to host 10.10.10.1, port 5201
    [  4] local 10.10.10.2 port 43764 connected to 10.10.10.1 port 5201
    [ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
    [  4]   0.00-5.00   sec  90.0 MBytes   151 Mbits/sec   70   1.29 KBytes       
    [  4]   5.00-10.01  sec  0.00 Bytes  0.00 bits/sec    1   1.29 KBytes       
    [  4]  10.01-15.00  sec  75.9 MBytes   128 Mbits/sec   55    537 KBytes       
    [  4]  15.00-20.00  sec   103 MBytes   173 Mbits/sec   25   1.29 KBytes       
    [  4]  20.00-25.01  sec  0.00 Bytes  0.00 bits/sec    2   1.29 KBytes       
    [  4]  25.01-30.01  sec  0.00 Bytes  0.00 bits/sec    1   1.29 KBytes       
    [  4]  30.01-35.00  sec  84.8 MBytes   142 Mbits/sec  225    386 KBytes       
    [  4]  35.00-40.01  sec  3.73 MBytes  6.26 Mbits/sec    4   1.29 KBytes       
    - - - - - - - - - - - - - - - - - - - - - - - - -
    [ ID] Interval           Transfer     Bandwidth       Retr
    [  4]   0.00-40.01  sec   358 MBytes  75.0 Mbits/sec  383             sender
    [  4]   0.00-40.01  sec   356 MBytes  74.5 Mbits/sec                  receiver

    iperf Done.
    [root@client ~]# iperf3 -c 10.10.10.1 -t 40 -i 5
    Connecting to host 10.10.10.1, port 5201
    [  4] local 10.10.10.2 port 43768 connected to 10.10.10.1 port 5201
    [ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
    [  4]   0.00-5.00   sec  61.7 MBytes   103 Mbits/sec   76   1.29 KBytes       
    [  4]   5.00-10.01  sec  0.00 Bytes  0.00 bits/sec    2   1.29 KBytes       
    [  4]  10.01-15.01  sec  0.00 Bytes  0.00 bits/sec    0   1.29 KBytes       
    [  4]  15.01-20.00  sec  42.5 MBytes  71.3 Mbits/sec   54   1.29 KBytes       
    [  4]  20.00-25.00  sec  0.00 Bytes  0.00 bits/sec    2   1.29 KBytes       
    [  4]  25.00-30.00  sec  79.8 MBytes   134 Mbits/sec  164   1.29 KBytes       
    [  4]  30.00-35.01  sec  0.00 Bytes  0.00 bits/sec    3   1.29 KBytes       
    [  4]  35.01-40.01  sec  0.00 Bytes  0.00 bits/sec    1   1.29 KBytes       
    - - - - - - - - - - - - - - - - - - - - - - - - -
    [ ID] Interval           Transfer     Bandwidth       Retr
    [  4]   0.00-40.01  sec   184 MBytes  38.6 Mbits/sec  302             sender
    [  4]   0.00-40.01  sec   181 MBytes  37.9 Mbits/sec                  receiver

    iperf Done.
    [root@client ~]# iperf3 -c 10.10.10.1 -t 40 -i 5
    Connecting to host 10.10.10.1, port 5201
    [  4] local 10.10.10.2 port 43772 connected to 10.10.10.1 port 5201
    [ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
    [  4]   0.00-5.00   sec  95.3 MBytes   160 Mbits/sec   13   1.29 KBytes       
    [  4]   5.00-10.00  sec  0.00 Bytes  0.00 bits/sec    2   1.29 KBytes       
    [  4]  10.00-15.01  sec  0.00 Bytes  0.00 bits/sec    1   1.29 KBytes       
    [  4]  15.01-20.00  sec  2.50 MBytes  4.20 Mbits/sec    1   1.10 MBytes       
    [  4]  20.00-25.01  sec  0.00 Bytes  0.00 bits/sec    0   1.10 MBytes       
    [  4]  25.01-30.01  sec  0.00 Bytes  0.00 bits/sec    0   1.10 MBytes       
    [  4]  30.01-35.00  sec  52.3 MBytes  87.8 Mbits/sec   74   1.29 KBytes       
    [  4]  35.00-40.01  sec  0.00 Bytes  0.00 bits/sec    3   1.29 KBytes       
    - - - - - - - - - - - - - - - - - - - - - - - - -
    [ ID] Interval           Transfer     Bandwidth       Retr
    [  4]   0.00-40.01  sec   150 MBytes  31.5 Mbits/sec   94             sender
    [  4]   0.00-40.01  sec   147 MBytes  30.9 Mbits/sec                  receiver

    iperf Done.     
    
</details>

средний результат по 3 замерам - tap:
```
sender - 75.0+38.6+31.5=145,1/3=48.36 Mbits/sec
receiver - 74.5+37.9+30.9=143,3/3=47.76 Mbits/sec
```

Замер скорости для tun:
<details>
 <summary> Вывод 3-х замеров </summary>

    [root@client ~]# iperf3 -c 10.10.10.1 -t 40 -i 5
    Connecting to host 10.10.10.1, port 5201
    [  4] local 10.10.10.2 port 43776 connected to 10.10.10.1 port 5201
    [ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
    [  4]   0.00-5.01   sec  18.3 MBytes  30.7 Mbits/sec   32   1.32 KBytes       
    [  4]   5.01-10.01  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    [  4]  10.01-15.00  sec  9.79 MBytes  16.4 Mbits/sec   51    521 KBytes       
    [  4]  15.00-20.00  sec  50.8 MBytes  85.2 Mbits/sec    3   1.32 KBytes       
    [  4]  20.00-25.01  sec  0.00 Bytes  0.00 bits/sec    2   1.32 KBytes       
    [  4]  25.01-30.01  sec  0.00 Bytes  0.00 bits/sec    0   1.32 KBytes       
    [  4]  30.01-35.00  sec  9.06 MBytes  15.2 Mbits/sec    5   1.32 KBytes       
    [  4]  35.00-40.01  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    --- - - - - - - - - - - - - - - - - - - - - - -
    [ ID] Interval           Transfer     Bandwidth       Retr
    [  4]   0.00-40.01  sec  87.9 MBytes  18.4 Mbits/sec   95             sender
    [  4]   0.00-40.01  sec  86.8 MBytes  18.2 Mbits/sec                  receiver

    iperf Done.
    [root@client ~]# iperf3 -c 10.10.10.1 -t 40 -i 5
    Connecting to host 10.10.10.1, port 5201
    [  4] local 10.10.10.2 port 43780 connected to 10.10.10.1 port 5201
    [ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
    [  4]   0.00-5.01   sec  3.90 MBytes  6.53 Mbits/sec    4   1.32 KBytes       
    [  4]   5.01-10.01  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    [  4]  10.01-15.00  sec  23.8 MBytes  39.9 Mbits/sec  126   1.32 KBytes       
    [  4]  15.00-20.01  sec  0.00 Bytes  0.00 bits/sec    2   1.32 KBytes       
    [  4]  20.01-25.01  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    [  4]  25.01-30.00  sec  68.0 MBytes   114 Mbits/sec   27    443 KBytes       
    [  4]  30.00-35.00  sec   146 MBytes   245 Mbits/sec    6    388 KBytes       
    [  4]  35.00-40.00  sec  56.9 MBytes  95.3 Mbits/sec    3   1.32 KBytes       
    - - - - - - - - - - - - - - - - - - - - - - - - -
    [ ID] Interval           Transfer     Bandwidth       Retr
    [  4]   0.00-40.00  sec   298 MBytes  62.5 Mbits/sec  170             sender
    [  4]   0.00-40.00  sec   298 MBytes  62.5 Mbits/sec                  receiver

    iperf Done.
    [root@client ~]# iperf3 -c 10.10.10.1 -t 40 -i 5
    Connecting to host 10.10.10.1, port 5201
    [  4] local 10.10.10.2 port 43784 connected to 10.10.10.1 port 5201
    [ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
    [  4]   0.00-5.01   sec  27.5 MBytes  46.1 Mbits/sec   26   1.32 KBytes       
    [  4]   5.01-10.01  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    [  4]  10.01-15.01  sec  0.00 Bytes  0.00 bits/sec    0   1.32 KBytes       
    [  4]  15.01-20.00  sec  24.4 MBytes  41.0 Mbits/sec  396   1.32 KBytes       
    [  4]  20.00-25.00  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    [  4]  25.00-30.00  sec  11.3 MBytes  18.9 Mbits/sec    7    398 KBytes       
    [  4]  30.00-35.00  sec  24.5 MBytes  41.1 Mbits/sec    4   1.32 KBytes       
    [  4]  35.00-40.01  sec  0.00 Bytes  0.00 bits/sec    1   1.32 KBytes       
    - - - - - - - - - - - - - - - - - - - - - - - - -
    [ ID] Interval           Transfer     Bandwidth       Retr
    [  4]   0.00-40.01  sec  87.7 MBytes  18.4 Mbits/sec  436             sender
    [  4]   0.00-40.01  sec  86.0 MBytes  18.0 Mbits/sec                  receiver

    iperf Done.

</details>


средний результат по 3 замерам - tun:
```
sender - 18.4+62.5+18.4=99.3/3=33.1 Mbits/sec
receiver - 18.2+62.5+18.0=98.7/3=32.9 Mbits/sec
```
По итогам замечено что у интерфейса типа - tap, скорость передачи данных чуть больше чем у tun.
>## Типы tun  и tap 
>__tun__  - (3 сетевой ур-нь модели OSI) нужен для объеденения 2-х локальных сетей в одну, условно общую, но с разной адресацией (192.168.20.0/24 и 192.168.40.0/24).  
>__tap__ - (2 канальный ур-нь OSI) нужен для обединение 2-х удаленных сетей в единое адресное пространство (192.168.10.0/24)

Так же у одного из пользователей github ([krote5k](https://github.com/krote5k))  я нашел интересное сравнение tun и tap:

<details>
    <summary> Отрывок из статьи... </summary>

    ## Сравнение режима tun с режимом tap

    Как мы уже видели в этой главе - есть много сходств, но также есть и существенные различия между VPN в режиме tun и VPN в режиме tap. В этом разделе мы обсудим эти сходства и различия. Большинство различий проистекает из единственного факта что VPN в режиме tun является не широковещательной, а двухточечной IP-сетью, в то время как сеть в режиме tap обеспечивает полностью виртуальную Ethernet-подобную сеть с поддержкой широковещания. Короче говоря, сеть в режиме tun обеспечивает сетевое подключение уровня 3, тогда как сеть в режиме tap обеспечивает практически все функциональные возможности сети уровня 2.

    Особенно с опцией `topology subnet` настройка на основе TUN напоминает установку без перемычек:

    * Опция `server 10.200.0.0 255.255.255.0` устанавливает VPN с адресом сервера 10.200.0.1. Каждый клиент получит один адрес _из 24 IP-адресной адресации, начиная с 10.200.0.2_.
    * Способ шифрования VPN-трафика и цифровой подписи (HMAC) идентичен.
    * Большинство возможностей сценариев применимы к обоим типам VPN. Однако есть некоторые тонкие различия в параметрах для сценария `client-connect`.
    * При правильной настройке конечный пользователь не будет испытывать различий между настройкой на основе tun и VPN-подключением на основе tap.

    Эти различия, конечно, гораздо интереснее обсуждать. Некоторые различия очевидны, но есть и некоторые тонкости, которые могут оказать существенное влияние при настройке VPN.

    ### Слой 2 против слоя 3

    В сети уровня 2 (т.е. в стиле tap) соседние клиенты могут связаться друг с другом узнав адрес соседа, используя широковещательные ARP-запросы. Широковещательные ARP-запросы позволяют клиентам обнаруживать MAC-адреса других клиентов. Это позволяет клиентам связываться друг с другом по протоколам IP и не-IP.

    В сети уровня 3 (в стиле tun) клиенты могут связываться друг с другом только с помощью IP-адресов. MAC-адрес адаптера tun никогда не раскрывается другим VPN-клиентам и даже самому серверу OpenVPN. Из-за этого сетевой пакет уровня 3 немного короче, чем уровня 2. При нормальных обстоятельствах более длинные сетевые пакеты уровня 2 не оказывают негативного влияния на производительность.

    ### Маршрутные различия и iroute

    Когда особенно необходима маршрутизация от подсети к подсети между tun и tap есть некоторые существенные различия. В сети в стиле tun необходим файл конфигурации клиента с соответствующим оператором `iroute` чтобы позволить VPN-серверу получать доступ к клиентам, находящимся в локальной сети на стороне клиента. В качестве примера мы предполагаем, что подсеть 192.168.3.0/24 может быть достигнута через клиента OpenVPN с сертификатом `CN=client1`. На сервере OpenVPN мы добавили бы файл `client-config-dir` с именем `client1`, содержащий инструкцию:

    ```
    iroute 192.168.3.0 255.255.255.0
    ```

    И добавили бы системный маршрут в файл конфигурации сервера:

    ```
    route 192.168.3.0 255.255.255.0
    ```

    В настройке в стиле tap оператор `iroute` недопустим и будет просто игнорироваться сервером. Чтобы достичь подсети _за_ VPN-клиентом необходимо добавить системный маршрут на сервере OpenVPN, а шлюз должен указывать на VPN-IP-адрес клиента. Давайте предположим, что для `client1` из предыдущего примера назначен фиксированный IP-адрес. Это может быть достигнуто с помощью файла CCD:

    ```
    ifconfig-push 10.200.0.99 255.255.255.0
    ```

    В файле конфигурации сервера необходимо добавить маршрут, чтобы таблицы системной маршрутизации знали, что подсеть 192.168.3.0/24 может быть доступна через клиента 10.200.0.99:

    ```
    route 192.168.3.0 255.255.255.0 10.200.0.99
    ```

    Это гораздо менее динамично, чем опция режима tun `route + iroute`.

    ### Фильтрация клиент-клиент

    При настройке в стиле tun большая часть трафика может регистрироваться и фильтроваться с использованием правил брандмауэра или iptables. Фильтрация трафика между клиентами OpenVPN намного сложнее при настройке в режиме tap, как было показано ранее в этой главе.

    ### Широковещание трафика и "болтливость" сети

    Сеть уровня 3 не позволяет передавать широковещательный трафик по ней. Это и преимущество и недостаток. Некоторые клиент-серверные приложения полагаются на использование широковещательного трафика для связи между сервером и клиентами. Для таких приложений требуется сеть в стиле tap.

    Однако широковещательный трафик также имеет тенденцию засорять сети. Даже если на клиенте нет действий пользователя - операционная система будет непрерывно отправлять широковещательный трафик для обнаружения сетевых ресурсов, соседей и т.д. Особенно, когда используются такие протоколы как Universal Plug-and-Play или Apple Bonjour существует много *скрытого* широковещательного трафика. Для клиентов, подключенных к VPN через сеть с низкой пропускной способностью - это может иметь серьезные последствия для производительности.

    ### Мост

    Ключевой особенностью сети в стиле tap является возможность создания мостов. Мостовое соединение невозможно в сети уровня 3.

    В некоторых редких случаях эта функция абсолютно необходима, но при любой возможности следует избегать мостовой настройки. Основной причиной неиспользования мостовой настройки является негативное влияние на производительность. Как объяснялось ранее - в мостовой конфигурации весь трафик из локальной сети на стороне сервера перенаправляется через VPN всем клиентам и наоборот. Когда множество клиентов подключены к сетям с низкой пропускной способностью - это может привести к обходу всей сети как на стороне клиента, так и в локальной сети на стороне сервера. Когда клиенты в локальной сети на стороне сервера пытаются обнаружить доступные ресурсы в сети (например, общие файловые ресурсы или принтеры в сети на основе CIFS) - вся сеть будет заполнена широковещательным трафиком. Клиенты локальной сети обычно ждут ответов от всех компьютеров, подключенных к сети, как локальной, так и VPN, прежде чем предлагать доступ к общим сетевым ресурсам или принтерам. Это может быстро привести к недопустимому времени отклика сети в случае когда подключается и отключается большое количество VPN-клиентов.

</details>

Полная статья есть [тут](https://github.com/translaster/Osvoenie-OpenVPN/blob/master/chapter-06.md?ysclid=l4k9qbzp2p387911041).

---

2. Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку.

Для этого нам потребуется одна из двух виртуальных машин допустим это будет ```server```.  Другую ВМ мы можем закоментирвать.

Развернрем наш стенд:
```
vagrant up
```

для настройки openvpn воспользуемся ролью ```openvpn-server``` она задейстована в ```playbook2.yml```. Запустим плейбук:
```
ansible-playbook playbook2.yml
```

